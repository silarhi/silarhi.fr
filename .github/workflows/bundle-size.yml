name: Bundle Size

on:
    pull_request:
        branches:
            - main

permissions:
    pull-requests: write

jobs:
    size:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout PR branch
              uses: actions/checkout@v4

            - name: Use Node.js LTS
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build
              run: yarn build

            - name: Get bundle size
              id: size
              run: |
                  SIZE_OUTPUT=$(yarn size:json 2>/dev/null || echo "[]")
                  echo "result<<EOF" >> $GITHUB_OUTPUT
                  echo "$SIZE_OUTPUT" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Post comment
              uses: actions/github-script@v7
              with:
                  script: |
                      const sizeData = ${{ steps.size.outputs.result }};

                      let table = '| Name | Size |\n|------|------|\n';
                      for (const entry of sizeData) {
                        const sizeKB = (entry.size / 1024).toFixed(2);
                        table += `| ${entry.name} | ${sizeKB} kB |\n`;
                      }

                      const body = `## ðŸ“¦ Bundle Size Report\n\n${table}\n\n<sub>Generated by size-limit</sub>`;

                      // Find existing comment
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const botComment = comments.find(c =>
                        c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
                      );

                      if (botComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: botComment.id,
                          body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body
                        });
                      }
