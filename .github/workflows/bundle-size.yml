name: Bundle Size

on:
    pull_request:
        branches:
            - main

permissions:
    pull-requests: write

jobs:
    size:
        runs-on: ubuntu-latest
        steps:
            - name: Use Node.js LTS
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            # Build base branch first
            - name: Checkout base branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.base_ref }}

            - name: Install dependencies (base)
              run: yarn install --frozen-lockfile

            - name: Build (base)
              run: yarn build

            - name: Get bundle size (base)
              run: |
                  yarn --silent size:json > /tmp/size-base.json 2>/dev/null || echo "[]" > /tmp/size-base.json
                  cat /tmp/size-base.json

            # Build PR branch
            - name: Checkout PR branch
              uses: actions/checkout@v4
              with:
                  clean: false

            - name: Install dependencies (PR)
              run: yarn install --frozen-lockfile

            - name: Build (PR)
              run: yarn build

            - name: Get bundle size (PR)
              run: |
                  yarn --silent size:json > /tmp/size-pr.json 2>/dev/null || echo "[]" > /tmp/size-pr.json
                  cat /tmp/size-pr.json

            - name: Post comparison comment
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');

                      const baseData = JSON.parse(fs.readFileSync('/tmp/size-base.json', 'utf8'));
                      const prData = JSON.parse(fs.readFileSync('/tmp/size-pr.json', 'utf8'));

                      // Create a map of base sizes
                      const baseMap = {};
                      for (const entry of baseData) {
                        baseMap[entry.name] = entry.size;
                      }

                      let table = '| Name | Base | PR | Diff |\n|------|------|-----|------|\n';

                      for (const entry of prData) {
                        const prSize = entry.size;
                        const baseSize = baseMap[entry.name] || 0;
                        const diff = prSize - baseSize;

                        const prKB = (prSize / 1024).toFixed(2);
                        const baseKB = (baseSize / 1024).toFixed(2);
                        const diffKB = (diff / 1024).toFixed(2);

                        let diffStr = '';
                        if (diff > 0) {
                          diffStr = `+${diffKB} kB ðŸ”º`;
                        } else if (diff < 0) {
                          diffStr = `${diffKB} kB ðŸŸ¢`;
                        } else {
                          diffStr = '0 kB';
                        }

                        table += `| ${entry.name} | ${baseKB} kB | ${prKB} kB | ${diffStr} |\n`;
                      }

                      const body = `## ðŸ“¦ Bundle Size Report\n\n${table}\n\n<sub>Comparing \`${{ github.base_ref }}\` (base) with \`${{ github.head_ref }}\` (PR)</sub>`;

                      // Find existing comment
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const botComment = comments.find(c =>
                        c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
                      );

                      if (botComment) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: botComment.id,
                          body
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body
                        });
                      }
